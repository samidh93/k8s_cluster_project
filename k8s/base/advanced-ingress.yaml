apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: todo-advanced-ingress
  namespace: todo-app
  labels:
    app: todo-app
    environment: development
    version: v1
  annotations:
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    nginx.ingress.kubernetes.io/rate-limit-burst: "200"
    
    # Load balancing
    nginx.ingress.kubernetes.io/load-balance: "round_robin"
    
    # SSL/TLS (for future use)
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    
    # CORS
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    nginx.ingress.kubernetes.io/cors-expose-headers: "Content-Length,Content-Range"
    
    # Health checks
    nginx.ingress.kubernetes.io/health-check-path: "/health"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    
    # Buffer sizes
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    
    # Compression
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/gzip-types: "text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json"
    
    # Rewrite rules
    nginx.ingress.kubernetes.io/rewrite-target: /
    
    # Session affinity
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "todo-session"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "3600"
    
    # Canary deployment support (for A/B testing)
    nginx.ingress.kubernetes.io/canary: "false"
    nginx.ingress.kubernetes.io/canary-weight: "0"
    
    # Custom error pages
    nginx.ingress.kubernetes.io/custom-http-errors: "404,500,502,503,504"
    
    # Logging
    nginx.ingress.kubernetes.io/enable-access-log: "true"

spec:
  ingressClassName: nginx
  
  # Default backend for unmatched routes
  defaultBackend:
    service:
      name: todo-nginx
      port:
        number: 80
  
  rules:
  # Frontend routes
  - host: todo.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: todo-nginx
            port:
              number: 80
  
  # API routes to backend
  - host: todo.local
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: todo-backend
            port:
              number: 8080
  
  # Health and monitoring routes
  - host: todo.local
    http:
      paths:
      - path: /actuator
        pathType: Prefix
        backend:
          service:
            name: todo-backend
            port:
              number: 8080
      - path: /health
        pathType: Exact
        backend:
          service:
            name: todo-nginx
            port:
              number: 80
  
  # Admin routes (for future use)
  - host: admin.todo.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: todo-backend
            port:
              number: 8080
